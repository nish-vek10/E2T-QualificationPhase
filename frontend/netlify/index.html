<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>E2T Country Allocation</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link href="https://api.fontshare.com/v2/css?f[]=switzer@400,500,600,700,800,900&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#0b0b0b; color:#eaeaea;
      font-family:"Switzer",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Helvetica Neue",sans-serif; }
    .wrap { max-width:900px; margin:24px auto; padding:0 16px; }
    h1 { text-align:center; font-weight:900; margin:8px 0 6px; }
    .sub { text-align:center; color:#aaa; margin-bottom:16px; }
    .list { display:grid; gap:14px; }
    .card { background:#121212; border:1px solid #2a2a2a; border-radius:16px; padding:14px;
            display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center; }
    .rowL { display:grid; gap:10px; }
    .top { display:flex; align-items:center; gap:10px; font-weight:800; }
    .flag { width:38px; height:28px; object-fit:cover; border-radius:3px; box-shadow:0 0 3px rgba(0,0,0,.6); }
    .bar { height:10px; border-radius:999px; background:#2a2a2a; overflow:hidden; }
    .fill { height:100%; background:linear-gradient(90deg,#20c997,#14b8a6); }
    .cap { font-size:12.5px; color:#cfcfcf; }
    .right { display:grid; gap:8px; justify-items:end; }
    .pill { padding:6px 12px; border-radius:999px; font-weight:800; font-size:12.5px;
            border:1px solid #2a2a2a; background:#181818; color:#cfcfcf; }
    .pill.ok { border-color:rgba(52,199,89,.5); background:rgba(52,199,89,.12); color:#34c759; }
    .pct { font-weight:900; font-size:18px; }
    .err { color:#ff6b6b; background:#1b0b0b; border:1px solid #3a1a1a; padding:10px 12px; border-radius:8px; }
    @media (max-width:640px){ .wrap{ margin:16px auto; } }
  </style>
</head>
<body>
  <div id="app" class="wrap">Loading…</div>

<script type="module">
  const root = document.querySelector("#app");
  const showError = (msg) => {
    root.innerHTML = `<div class="wrap"><h1>Country Allocation Progress</h1>
      <div class="err">Error: ${msg}</div></div>`;
  };

  try {
    // --- Load i18n-iso-countries as real ESM (fixes "Illegal return statement") ---
    // esm.sh serves ESM bundles that browsers can import directly.
    const countriesPkg = await import("https://esm.sh/i18n-iso-countries@7.14.0");
    const countries = countriesPkg.default || countriesPkg;

    // Load locale JSON via fetch (no JSON module assertion needed)
    try {
      const res = await fetch("https://cdn.jsdelivr.net/npm/i18n-iso-countries@7.14.0/langs/en.json");
      const enLocale = await res.json();
      countries.registerLocale(enLocale);
    } catch (e) {
      console.warn("Locale load failed, continuing without it:", e);
    }

    // --- Aliases + helpers (same as before) ---
    const ALIAS = {
      "uk":"United Kingdom","u.k.":"United Kingdom","gb":"United Kingdom","great britain":"United Kingdom","britain":"United Kingdom",
      "uae":"United Arab Emirates","u.a.e.":"United Arab Emirates",
      "usa":"United States of America","u.s.a.":"United States of America","united states":"United States of America","us":"United States of America",
      "russia":"Russian Federation","kyrgyzstan":"Kyrgyz Republic","czech republic":"Czechia",
      "ivory coast":"Côte d'Ivoire","cote d'ivoire":"Côte d'Ivoire","côte d'ivoire":"Côte d'Ivoire",
      "dr congo":"Congo, Democratic Republic of the","democratic republic of the congo":"Congo, Democratic Republic of the","republic of the congo":"Congo",
      "swaziland":"Eswatini","cape verde":"Cabo Verde","palestine":"Palestine, State of",
      "iran":"Iran, Islamic Republic of","syria":"Syrian Arab Republic","moldova":"Moldova, Republic of",
      "venezuela":"Venezuela, Bolivarian Republic of","bolivia":"Bolivia, Plurinational State of",
      "laos":"Lao People's Democratic Republic","brunei":"Brunei Darussalam","vietnam":"Viet Nam",
      "south korea":"Korea, Republic of","north korea":"Korea, Democratic People's Republic of",
      "macau":"Macao","hong kong":"Hong Kong","myanmar":"Myanmar","north macedonia":"North Macedonia",
      "são tomé and príncipe":"Sao Tome and Principe","sao tome and principe":"Sao Tome and Principe",
      "micronesia":"Micronesia, Federated States of","st kitts and nevis":"Saint Kitts and Nevis","saint kitts and nevis":"Saint Kitts and Nevis",
      "st lucia":"Saint Lucia","saint lucia":"Saint Lucia",
      "st vincent and the grenadines":"Saint Vincent and the Grenadines","saint vincent and the grenadines":"Saint Vincent and the Grenadines",
      "antigua":"Antigua and Barbuda","bahamas":"Bahamas","gambia":"Gambia","bahrein":"Bahrain",
      "netherlands the":"Netherlands","republic of ireland":"Ireland","eswatini":"Eswatini","kosovo":"Kosovo"
    };
    const alpha2 = (name) => {
      if (!name) return null;
      let code = countries.getAlpha2Code(name, "en");
      if (!code) {
        const alias = ALIAS[String(name).toLowerCase()];
        if (alias) code = countries.getAlpha2Code(alias, "en") || (alias.toLowerCase()==="kosovo" ? "XK" : null);
      }
      if (!code) {
        const cleaned = String(name).replace(/[().]/g,"").replace(/\s+/g," ").trim();
        code = countries.getAlpha2Code(cleaned, "en");
      }
      return code ? code.toLowerCase() : null;
    };
    const flagImg = (country) => {
      const code = alpha2(country);
      return code ? `<img class="flag" src="https://flagcdn.com/w40/${code}.png" alt="${country||""}">` : "";
    };
    const fmtPct = (v) => (Number(v)||0).toFixed(1) + "%";

    // ===== SET YOUR COUNTRY-ALLOCATION SUPABASE CREDS (public anon) =====
    const SUPABASE_URL  = "https://vdtuneabmsvfmfopmpdc.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkdHVuZWFibXN2Zm1mb3BtcGRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNDQ1ODgsImV4cCI6MjA3NDgyMDU4OH0.gRuI2YURZdBWwsWsuFmpfwFcdoU5aJoE369fnF-HOLo";

    // Fetch view via REST
    const url = `${SUPABASE_URL}/rest/v1/v_e2t_country_allocation?select=country,pct_goal,is_qualified&order=pct_goal.desc`;
    const res = await fetch(url, { headers: { apikey: SUPABASE_ANON, Authorization: `Bearer ${SUPABASE_ANON}` } });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
    const rows = await res.json();

    // Render
    if (!Array.isArray(rows) || rows.length === 0) {
      root.innerHTML = `<div class="wrap"><h1>Country Allocation Progress</h1>
        <div class="sub">Towards US$1,000,000 goal • Live stats</div><p>No data.</p></div>`;
    } else {
      let html = `<div class="wrap">
        <h1>COUNTRY ALLOCATION PROGRESS</h1>
        <div class="sub">Towards US$1,000,000 goal  •  Live stats</div>
        <div class="list">`;
      for (const r of rows) {
        const pct = Math.max(0, Math.min(100, Number(r.pct_goal || 0)));
        const qualified = !!r.is_qualified;
        html += `
          <div class="card">
            <div class="rowL">
              <div class="top">
                ${flagImg(r.country)}
                <span style="font-size:18px">${r.country || "Unknown"}</span>
              </div>
              <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
              <div class="cap"><strong>${fmtPct(pct)}</strong> of US$1,000,000</div>
            </div>
            <div class="right">
              <div class="pill ${qualified ? "ok" : ""}">${qualified ? "Qualified" : "Pending"}</div>
              <div class="pct">${fmtPct(pct)}</div>
            </div>
          </div>`;
      }
      html += `</div></div>`;
      root.innerHTML = html;
    }
  } catch (e) {
    console.error(e);
    showError(e.message || e);
  }
</script>
</body>
</html>
